#!/bin/bash

sed 's/HOSTIP/'"$HOST_IP"'/g' -i /var/www/html/harness.json

if [ -e "/extra/config/app.config" ]; then
	appconfig=`cat /extra/config/app.config`
	jq ".applications |= .+ [ $appconfig ]" /var/www/html/harness.json > /tmp/nginx/harness.json
	cp /tmp/nginx/harness.json /var/www/html/harness.json
	chmod a+wr /tmp/nginx/harness.json
fi

service fcgiwrap start
service nginx start

service mongodb start
service memcached start

# If user has mounted (vid Docker's -v argument) a directory /import then we'll 
# slurp data from that directory into MongoDB using the file names as collection names.
if [ -d "/extra/mongo" ]; then
	for dbdir in $(ls -d /extra/mongo/*); do
		db=$(basename $dbdir)
		for f in $(ls $dbdir/*.js); do
			filename=$(basename $f)
			coll=${filename%.*}
			mongoimport --db $db --collection $coll --file $f
		done
	done
fi

# If /extra is mounted then look for app.config file and glom its contents
# into the 'applications' section of harness.json

if [ -d "/extra/http" ]; then
	cp /extra/http/* /var/www/html/
fi

rabbitmq-server
